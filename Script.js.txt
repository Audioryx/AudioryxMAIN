// auth helpers
function saveToken(t){ localStorage.setItem('ax_token', t); }
function getToken(){ return localStorage.getItem('ax_token'); }
function authFetch(url, opts={}){
  opts.headers = opts.headers || {};
  const token = getToken();
  if(token) opts.headers['Authorization'] = 'Bearer ' + token;
  if(!opts.headers['Content-Type']) { /* leave for multipart */ }
  return fetch(url, opts).then(r=>r.json());
}

// Login form -> call /api/auth/login
async function doLogin(email,password){
  const res = await fetch('/api/auth/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
  if(res.ok){
    const data = await res.json();
    saveToken(data.token);
    currentUser = data.user;
    await loadUserTracks();
  } else {
    alert('Login failed');
  }
}

// Upload file to server
document.getElementById('upload').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const fd = new FormData();
  fd.append('file', file);
  const token = getToken();
  const res = await fetch('/api/tracks/upload', { method:'POST', body: fd, headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
  const json = await res.json();
  if(json.error) return alert('Upload error: ' + json.error);
  // Reload library from server
  await loadUserTracks();
});

async function loadUserTracks(){
  const token = getToken();
  if(!token) return; // prompt login
  const res = await fetch('/api/tracks', { headers: { 'Authorization': 'Bearer ' + token }});
  const list = await res.json();
  // map list to UI cards and set audio.src = list[0].url when playing
  // note: urls are /uploads/filename served by server
}